---
title: "Introduction to Splines"
author: "Andy Shen, Devin Francom"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Let's say you want to fit a model using some wiggly data.  Maybe

```{r cars}
n<-300
x<-seq(0,1,length.out=n)
y<-sin(2*pi*x^2)*10+rnorm(n)
plot(x,y)
```

One way to fit a model to data like this is to come up with a linear basis and fit a linear model using the basis as the X matrix (which we will call B).  People often use splines as a basis.  The simplest set of spline basis functions would be to make the ith basis function (i.e., the ith column of B) look like
$$ B_{ij} = [s_i(x_j - t_i)]_+  $$
where $s\in \lbrace -1,1 \rbrace$, which we'll call the sign, and $t$ is a value in the domain of $x$, which we will call a knot.  Also, $[a]_+ = max(0,a)$.

Try some combinations of $s$ and $t$ to see what your basis functions look like, and what the corresponding linear model fit looks like (using the lm function or your Bayesian linear model code).  Try with different numbers of basis functions, also.

\pagebreak

```{r}
t1 <- 0.5 #knot at 0.5
s <- 1
B1 <- rep(NA, length(x))

for(i in 1:length(x)) {
  B1[i] <- max(s * (x[i] - t1), 0)
}
mod <- lm(y ~ B1)
summary(mod)

cf <- mod$coefficients
sq <- x
hs <- (sq - t1)
hs[sq < t1] <- 0
yfit <- cf[1] + cf[2]*hs

plot(x,y, main = "Manual Basis Spline")
lines(x, yfit, type = "l", lwd = 5, col="navy")
```

\  

Add another knot

```{r}
t1 <- 0.5 #knot at 0.5
t2 <- 0.85 #another knot at 0.85
s <- 1
B1 <- rep(NA, length(x))
B2 <- B1

for(i in 1:length(x)) {
  B1[i] <- max(s * (x[i] - t1), 0)
  B2[i] <- max(s * (x[i] - t2), 0)
}
mod <- lm(y ~ B1 + B2)
summary(mod)

cf <- mod$coefficients
sq <- x

hs1 <- (sq - t1)
hs1[sq < t1] <- 0

hs2 <- (sq - t2)
hs2[sq < t2] <- 0

yfit <- cf[1] + cf[2]*hs1 + cf[3]*hs2

plot(x,y, main = "Manual Basis Spline")
lines(x, yfit, type = "l", lwd = 5, col="navy")
```


# Using the `bs()` Function

## 2 Knots (Expected)

```{r}
library(splines)
df <- data.frame(y, x)
m1 <- lm(y ~ bs(x, knots = c(0.5, 0.82)), data = df)
pred <- predict(m1)

plot(x,y)
lines(x, pred, lwd = 5, col = "blue")

summary(m1)
```

\pagebreak

## Too Many Knots

```{r}
m2 <- lm(y ~ bs(x, knots = seq(0.1,1,by=0.02)), data = df)
pred <- predict(m2)

plot(x,y)
lines(x, pred, lwd = 5, col = "green")
```

\pagebreak

## 1 Knot

```{r}
m2 <- lm(y ~ bs(x, knots = 0.5), data = df)
pred <- predict(m2)

plot(x,y)
lines(x, pred, lwd = 5, col = "green")

summary(m2)
```

```{r}
m2 <- lm(y ~ bs(x, knots = 0.8), data = df)
pred <- predict(m2)

plot(x,y)
lines(x, pred, lwd = 5, col = "green")

summary(m2)
```





\pagebreak

# Natural Splines


```{r}
m3 <- lm(y ~ ns(x, knots = c(0.5, 0.82)), data = df)
pred <- predict(m3)

plot(x,y)
lines(x, pred, lwd = 5, col = "purple")

summary(m1)
```






